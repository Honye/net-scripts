var r=Uint8Array,n=Uint16Array,t=Int32Array,e=new r([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),a=new r([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new r([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=function(r,e){for(var a=new n(31),o=0;o<31;++o)a[o]=e+=1<<r[o-1];var f=new t(a[30]);for(o=1;o<30;++o)for(var i=a[o];i<a[o+1];++i)f[i]=i-a[o]<<5|o;return{b:a,r:f}},i=f(e,2),l=i.b,s=i.r;l[28]=258,s[258]=28;for(var u=f(a,0).r,c=new n(32768),h=0;h<32768;++h){var v=(43690&h)>>1|(21845&h)<<1;v=(61680&(v=(52428&v)>>2|(13107&v)<<2))>>4|(3855&v)<<4,c[h]=((65280&v)>>8|(255&v)<<8)>>1}var g=function(r,t,e){for(var a=r.length,o=0,f=new n(t);o<a;++o)r[o]&&++f[r[o]-1];var i,l=new n(t);for(o=1;o<t;++o)l[o]=l[o-1]+f[o-1]<<1;if(e){i=new n(1<<t);var s=15-t;for(o=0;o<a;++o)if(r[o])for(var u=o<<4|r[o],h=t-r[o],v=l[r[o]-1]++<<h,g=v|(1<<h)-1;v<=g;++v)i[c[v]>>s]=u}else for(i=new n(a),o=0;o<a;++o)r[o]&&(i[o]=c[l[r[o]-1]++]>>15-r[o]);return i},w=new r(288);for(h=0;h<144;++h)w[h]=8;for(h=144;h<256;++h)w[h]=9;for(h=256;h<280;++h)w[h]=7;for(h=280;h<288;++h)w[h]=8;var p=new r(32);for(h=0;h<32;++h)p[h]=5;var d=g(w,9,0),m=g(p,5,0),y=function(r){return(r+7)/8|0},$=function(n,t,e){return(null==e||e>n.length)&&(e=n.length),new r(n.subarray(t,e))},b=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],M=function(r,n,t){var e=new Error(n||b[r]);if(e.code=r,Error.captureStackTrace&&Error.captureStackTrace(e,M),!t)throw e;return e},x=function(r,n,t){t<<=7&n;var e=n/8|0;r[e]|=t,r[e+1]|=t>>8},A=function(r,n,t){t<<=7&n;var e=n/8|0;r[e]|=t,r[e+1]|=t>>8,r[e+2]|=t>>16},T=function(t,e){for(var a=[],o=0;o<t.length;++o)t[o]&&a.push({s:o,f:t[o]});var f=a.length,i=a.slice();if(!f)return{t:S,l:0};if(1==f){var l=new r(a[0].s+1);return l[a[0].s]=1,{t:l,l:1}}a.sort(function(r,n){return r.f-n.f}),a.push({s:-1,f:25001});var s=a[0],u=a[1],c=0,h=1,v=2;for(a[0]={s:-1,f:s.f+u.f,l:s,r:u};h!=f-1;)s=a[a[c].f<a[v].f?c++:v++],u=a[c!=h&&a[c].f<a[v].f?c++:v++],a[h++]={s:-1,f:s.f+u.f,l:s,r:u};var g=i[0].s;for(o=1;o<f;++o)i[o].s>g&&(g=i[o].s);var w=new n(g+1),p=k(a[h-1],w,0);if(p>e){o=0;var d=0,m=p-e,y=1<<m;for(i.sort(function(r,n){return w[n.s]-w[r.s]||r.f-n.f});o<f;++o){var $=i[o].s;if(!(w[$]>e))break;d+=y-(1<<p-w[$]),w[$]=e}for(d>>=m;d>0;){var b=i[o].s;w[b]<e?d-=1<<e-w[b]++-1:++o}for(;o>=0&&d;--o){var M=i[o].s;w[M]==e&&(--w[M],++d)}p=e}return{t:new r(w),l:p}},k=function(r,n,t){return-1==r.s?Math.max(k(r.l,n,t+1),k(r.r,n,t+1)):n[r.s]=t},z=function(r){for(var t=r.length;t&&!r[--t];);for(var e=new n(++t),a=0,o=r[0],f=1,i=function(r){e[a++]=r},l=1;l<=t;++l)if(r[l]==o&&l!=t)++f;else{if(!o&&f>2){for(;f>138;f-=138)i(32754);f>2&&(i(f>10?f-11<<5|28690:f-3<<5|12305),f=0)}else if(f>3){for(i(o),--f;f>6;f-=6)i(8304);f>2&&(i(f-3<<5|8208),f=0)}for(;f--;)i(o);f=1,o=r[l]}return{c:e.subarray(0,a),n:t}},E=function(r,n){for(var t=0,e=0;e<n.length;++e)t+=r[e]*n[e];return t},C=function(r,n,t){var e=t.length,a=y(n+2);r[a]=255&e,r[a+1]=e>>8,r[a+2]=255^r[a],r[a+3]=255^r[a+1];for(var o=0;o<e;++o)r[a+o+4]=t[o];return 8*(a+4+e)},D=function(r,t,f,i,l,s,u,c,h,v,y){x(t,y++,f),++l[256];for(var $=T(l,15),b=$.t,M=$.l,k=T(s,15),D=k.t,P=k.l,S=z(b),U=S.c,F=S.n,I=z(D),O=I.c,q=I.n,H=new n(19),J=0;J<U.length;++J)++H[31&U[J]];for(J=0;J<O.length;++J)++H[31&O[J]];for(var N=T(H,7),W=N.t,Y=N.l,_=19;_>4&&!W[o[_-1]];--_);var j,B,G,K,L=v+5<<3,Q=E(l,w)+E(s,p)+u,R=E(l,b)+E(s,D)+u+14+3*_+E(H,W)+2*H[16]+3*H[17]+7*H[18];if(h>=0&&L<=Q&&L<=R)return C(t,y,r.subarray(h,h+v));if(x(t,y,1+(R<Q)),y+=2,R<Q){j=g(b,M,0),B=b,G=g(D,P,0),K=D;var V=g(W,Y,0);x(t,y,F-257),x(t,y+5,q-1),x(t,y+10,_-4),y+=14;for(J=0;J<_;++J)x(t,y+3*J,W[o[J]]);y+=3*_;for(var X=[U,O],Z=0;Z<2;++Z){var rr=X[Z];for(J=0;J<rr.length;++J){var nr=31&rr[J];x(t,y,V[nr]),y+=W[nr],nr>15&&(x(t,y,rr[J]>>5&127),y+=rr[J]>>12)}}}else j=d,B=w,G=m,K=p;for(J=0;J<c;++J){var tr=i[J];if(tr>255){A(t,y,j[(nr=tr>>18&31)+257]),y+=B[nr+257],nr>7&&(x(t,y,tr>>23&31),y+=e[nr]);var er=31&tr;A(t,y,G[er]),y+=K[er],er>3&&(A(t,y,tr>>5&8191),y+=a[er])}else A(t,y,j[tr]),y+=B[tr]}return A(t,y,j[256]),y+B[256]},P=new t([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),S=new r(0),U=function(){for(var r=new Int32Array(256),n=0;n<256;++n){for(var t=n,e=9;--e;)t=(1&t&&-306674912)^t>>>1;r[n]=t}return r}(),F=function(){var r=-1;return{p:function(n){for(var t=r,e=0;e<n.length;++e)t=U[255&t^n[e]]^t>>>8;r=t},d:function(){return~r}}},I=function(o,f,i,l,c){if(!c&&(c={l:1},f.dictionary)){var h=f.dictionary.subarray(-32768),v=new r(h.length+o.length);v.set(h),v.set(o,h.length),o=v,c.w=h.length}return function(o,f,i,l,c,h){var v=h.z||o.length,g=new r(l+v+5*(1+Math.ceil(v/7e3))+c),w=g.subarray(l,g.length-c),p=h.l,d=7&(h.r||0);if(f){d&&(w[0]=h.r>>3);for(var m=P[f-1],b=m>>13,M=8191&m,x=(1<<i)-1,A=h.p||new n(32768),T=h.h||new n(x+1),k=Math.ceil(i/3),z=2*k,E=function(r){return(o[r]^o[r+1]<<k^o[r+2]<<z)&x},S=new t(25e3),U=new n(288),F=new n(32),I=0,O=0,q=h.i||0,H=0,J=h.w||0,N=0;q+2<v;++q){var W=E(q),Y=32767&q,_=T[W];if(A[Y]=_,T[W]=Y,J<=q){var j=v-q;if((I>7e3||H>24576)&&(j>423||!p)){d=D(o,w,0,S,U,F,O,H,N,q-N,d),H=I=O=0,N=q;for(var B=0;B<286;++B)U[B]=0;for(B=0;B<30;++B)F[B]=0}var G=2,K=0,L=M,Q=Y-_&32767;if(j>2&&W==E(q-Q))for(var R=Math.min(b,j)-1,V=Math.min(32767,q),X=Math.min(258,j);Q<=V&&--L&&Y!=_;){if(o[q+G]==o[q+G-Q]){for(var Z=0;Z<X&&o[q+Z]==o[q+Z-Q];++Z);if(Z>G){if(G=Z,K=Q,Z>R)break;var rr=Math.min(Q,Z-2),nr=0;for(B=0;B<rr;++B){var tr=q-Q+B&32767,er=tr-A[tr]&32767;er>nr&&(nr=er,_=tr)}}}Q+=(Y=_)-(_=A[Y])&32767}if(K){S[H++]=268435456|s[G]<<18|u[K];var ar=31&s[G],or=31&u[K];O+=e[ar]+a[or],++U[257+ar],++F[or],J=q+G,++I}else S[H++]=o[q],++U[o[q]]}}for(q=Math.max(q,J);q<v;++q)S[H++]=o[q],++U[o[q]];d=D(o,w,p,S,U,F,O,H,N,q-N,d),p||(h.r=7&d|w[d/8|0]<<3,d-=7,h.h=T,h.p=A,h.i=q,h.w=J)}else{for(q=h.w||0;q<v+p;q+=65535){var fr=q+65535;fr>=v&&(w[d/8|0]=p,fr=v),d=C(w,d+1,o.subarray(q,fr))}h.i=v}return $(g,0,l+y(d)+c)}(o,null==f.level?6:f.level,null==f.mem?c.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(o.length)))):20:12+f.mem,i,l,c)},O=function(r,n){var t={};for(var e in r)t[e]=r[e];for(var e in n)t[e]=n[e];return t},q=function(r,n,t){for(;t;++n)r[n]=t,t>>>=8};function H(r,n){return I(r,n||{},0,0)}var J=function(n,t,e,a){for(var o in n){var f=n[o],i=t+o,l=a;Array.isArray(f)&&(l=O(a,f[1]),f=f[0]),f instanceof r?e[i]=[f,l]:(e[i+="/"]=[new r(0),l],J(f,i,e,a))}},N="undefined"!=typeof TextEncoder&&new TextEncoder,W="undefined"!=typeof TextDecoder&&new TextDecoder;try{W.decode(S,{stream:!0})}catch(r){}function Y(n,t){if(N)return N.encode(n);for(var e=n.length,a=new r(n.length+(n.length>>1)),o=0,f=function(r){a[o++]=r},i=0;i<e;++i){if(o+5>a.length){var l=new r(o+8+(e-i<<1));l.set(a),a=l}var s=n.charCodeAt(i);s<128||t?f(s):s<2048?(f(192|s>>6),f(128|63&s)):s>55295&&s<57344?(f(240|(s=65536+(1047552&s)|1023&n.charCodeAt(++i))>>18),f(128|s>>12&63),f(128|s>>6&63),f(128|63&s)):(f(224|s>>12),f(128|s>>6&63),f(128|63&s))}return $(a,0,o)}var _=function(r){var n=0;if(r)for(var t in r){var e=r[t].length;e>65535&&M(9),n+=e+4}return n},j=function(r,n,t,e,a,o,f,i){var l=e.length,s=t.extra,u=i&&i.length,c=_(s);q(r,n,null!=f?33639248:67324752),n+=4,null!=f&&(r[n++]=20,r[n++]=t.os),r[n]=20,n+=2,r[n++]=t.flag<<1|(o<0&&8),r[n++]=a&&8,r[n++]=255&t.compression,r[n++]=t.compression>>8;var h=new Date(null==t.mtime?Date.now():t.mtime),v=h.getFullYear()-1980;if((v<0||v>119)&&M(10),q(r,n,v<<25|h.getMonth()+1<<21|h.getDate()<<16|h.getHours()<<11|h.getMinutes()<<5|h.getSeconds()>>1),n+=4,-1!=o&&(q(r,n,t.crc),q(r,n+4,o<0?-o-2:o),q(r,n+8,t.size)),q(r,n+12,l),q(r,n+14,c),n+=16,null!=f&&(q(r,n,u),q(r,n+6,t.attrs),q(r,n+10,f),n+=14),r.set(e,n),n+=l,c)for(var g in s){var w=s[g],p=w.length;q(r,n,+g),q(r,n+2,p),r.set(w,n+4),n+=4+p}return u&&(r.set(i,n),n+=u),n};function B(n,t){t||(t={});var e={},a=[];J(n,"",e,t);var o=0,f=0;for(var i in e){var l=e[i],s=l[0],u=l[1],c=0==u.level?0:8,h=(T=Y(i)).length,v=u.comment,g=v&&Y(v),w=g&&g.length,p=_(u.extra);h>65535&&M(11);var d=c?H(s,u):s,m=d.length,y=F();y.p(s),a.push(O(u,{size:s.length,crc:y.d(),c:d,f:T,m:g,u:h!=i.length||g&&v.length!=w,o:o,compression:c})),o+=30+h+p+m,f+=76+2*(h+p)+(w||0)+m}for(var $=new r(f+22),b=o,x=f-o,A=0;A<a.length;++A){var T=a[A];j($,T.o,T,T.f,T.u,T.c.length);var k=30+T.f.length+_(T.extra);$.set(T.c,T.o+k),j($,o,T,T.f,T.u,T.c.length,T.o,T.m),o+=16+k+(T.m?T.m.length:0)}return function(r,n,t,e,a){q(r,n,101010256),q(r,n+8,t),q(r,n+10,t),q(r,n+12,e),q(r,n+16,a)}($,o,a.length,x,b),$}const G=$argument.token;function K(r){return new Promise(async(n,t)=>{try{const t=await function(r){const n={};G&&(n.Authorization=`token ${G}`);return new Promise((t,e)=>{$httpClient.get({url:r,headers:n},(r,n,a)=>{r||200!==n.status?e(new Error(`API 请求失败: ${r||n.status}`)):t(JSON.parse(a))})})}(r);let e=[];for(const r of t)if("file"===r.type)e.push({path:r.path,url:r.download_url});else if("dir"===r.type){const n=await K(r.url);e=e.concat(n)}n(e)}catch(r){t(r)}})}function L(r){$done({response:{status:500,headers:{"Content-Type":"text/plain; charset=utf-8"},body:r}})}!async function(){const r=$request.url,n=r.match(/^https:\/\/github\.com\/([^/]+)\/([^/]+)\/tree\/([^/]+)\/(.+)\.zip$/);if(!n)return $done({});try{const[,r,t,e,a]=n,o=`https://api.github.com/repos/${r}/${t}/contents/${a}?ref=${e}`;console.log(`开始处理: ${r}/${t}/${e}/${a}`);const f=await K(o);if(0===f.length)return L("此文件夹为空或不存在。");console.log(`找到 ${f.length} 个文件，开始下载...`);const i=await Promise.all(f.map(r=>{return n=r,new Promise(r=>{$httpClient.get({url:n.url,"binary-mode":!0},(t,e,a)=>{t||200!==e.status?(console.log(`下载失败: ${n.path}`),r(null)):r({path:n.path,content:new Uint8Array(a)})})});var n})),l={};i.forEach(r=>{if(r){const n=r.path.startsWith(a+"/")?r.path.substring(a.length+1):r.path;l[n]=r.content}}),console.log("所有文件下载完成，开始压缩...");const s=B(l);console.log("压缩完成，准备响应。");const u=a.split("/").pop()+".zip";$done({response:{status:200,headers:{"Content-Type":"application/zip","Content-Disposition":`attachment; filename="${u}"`},body:s}})}catch(r){console.log(`脚本出错: ${r.message}`),L(`脚本执行失败: ${r.message}`)}}();
